---
title: "[Docker] 如何像 override.yaml 一樣優雅地管理 .env 環境變數？"
pubDate: 2026-02-05
description: "深入探討 Docker Compose 環境變數的管理技巧，包含多個 .env 文件的覆蓋機制、YAML 錨點的應用，以及變數載入的優先順序。"
tags: ["Docker", "DevOps", "Infrastructure"]
---

import { Image } from 'astro:assets';

在開發 Docker 專案時，我們習慣使用 `docker-compose.override.yaml` 來區分開發與生產環境的配置。但你是否曾想過：**環境變數（.env）是否也有類似的「自動覆蓋」機制？**  
(其實是我自己覺得用dify每次更新需要自己去比對`.env`跟`.env.example`的差分太麻煩了)

事實上，Docker Compose 默認並不會自動尋找 `.env.override` 之類的文件。但透過理性的架構設計，我們可以利用以下三種方式達成相同的效果。

---

## 一、 命令行層級的覆蓋：使用 `--env-file`

這是最接近 `override.yaml` 行為的方式。當你手動指定多個文件時，**後者會覆蓋前者**。這在切換不同環境（如 Testing, Staging）時非常強大。

### 操作範例
```bash
# 基礎配置在 .env，差異化配置在 .env.local
docker compose --env-file .env --env-file .env.local up -d
```

* **優點**：極具彈性，能確保敏感資訊（如 .env.local）與基礎配置完全分離。
* **缺點**：每次下指令都要帶長參數，建議將此指令封裝進 `Makefile` 或 `scripts` 中。


---

## 二、 設定檔層級的「全域」引用：YAML 錨點 (Anchors)

如果你有多個服務（Services）需要共用同一套變數文件，且不想在每個服務下重複撰寫，使用 YAML 的 **錨點（&）與引用（*）** 是最優雅的解決方案。這也是維護大型專案時，保持代碼 **DRY (Don't Repeat Yourself)** 的關鍵。

### YAML 範例

```yaml
# 1. 定義共用配置塊 (以 x- 開頭，Compose 會忽略此區塊不直接解析為服務)
x-common-config: &base-env
  env_file:
    - .env
    - .env.local  # 後者覆蓋前者

services:
  api-server:
    <<: *base-env  # 2. 引用共用配置
    image: my-api:latest

  worker:
    <<: *base-env  # 3. 引用共用配置
    image: my-worker:latest
```

* 特性： 同樣遵循「後者覆蓋前者」的邏輯。
* 應用場景： 當你有一套標準的環境變數，但針對特定服務需要微調時非常有用。


---

## 三、 核心機制：環境變數優先級 (Priority Table)

在設計系統架構或排查變數生效問題時，理解 Docker 的變數加載優先級至關重要。當同一個變數在多處定義時，優先級如下：

| 優先級 | 來源 | 說明 |
| --- | --- | --- |
| **1 (最高)** | **Shell 環境變數** | 執行指令前直接 `export` 的變數。 |
| **2** | **Compose `environment` 區塊** | 直接硬編碼在 `docker-compose.yml` 內的變數。 |
| **3** | **`--env-file` 參數** | 命令行指定的文件，愈後者優先。 |
| **4** | **Compose `env_file` 屬性** | YAML 內指定的文件列表，愈後者優先。 |
| **5 (最低)** | **默認 `.env` 文件** | 專案根目錄下的基本配置。 |


---

## 針對 Dify 等開源專案的工程實踐建議
保持 `.env` 與官方的 `.example` 同步，將你個人的自定義配置（如資料庫密鑰、API Key）全部移到 `.env.local`。這樣下次更新時，直接覆蓋 `.env` 即可，完全不需要手動比對差分。

PS, 別忘了將 `.env.local` 加入你的 `.gitignore`，避免將私人密鑰或開發環境配置意外推送到 GitHub。


---

**延伸閱讀：**

* [Set environment variables within your container's environment](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)

